<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Carboard Map</title>
    <style>
/* Always set the map height explicitly to define the size of the div
 * element that contains the map. */
#map {
	height: 100%;
}
/* Optional: Makes the sample page fill the window. */
html, body {
height: 100%;
margin: 0;
padding: 0;
}
</style>
</head>

<body>
<div id="map"></div>
<script>
function downloadUrl(url,callback) {
 var request = window.ActiveXObject ?
     new ActiveXObject('Microsoft.XMLHTTP') :
     new XMLHttpRequest;
 request.onreadystatechange = function() {
   if (request.readyState == 4) {
     //request.onreadystatechange = doNothing;
     callback(request, request.status);
   }
 };
 request.open('GET', url, true);
 request.send(null);
}
function initMap() {
	var OSU = {
		lat: 44.562854,
     		lng: -123.278977
	};
	var map = new google.maps.Map(document.getElementById('map'), {
		zoom: 8,
		center: {lat: 45.512794, lng: -122.679565}
	});
	var OSUmarker = new google.maps.Marker({
		position: OSU,
		map: map,
		title: 'Oregon State University'
	});
	var contentString = '<div><strong>Oregon State University</strong><br>' +
	'Research-centric public school founded in 1868, with popular engineering &science programs <br>' +
	'Website: www.oregonstate.edu' + '<br></div>';
	var OSUinfowindow = new google.maps.InfoWindow({
		content: contentString
	});
	OSUmarker.addListener('click', function() {
		OSUinfowindow.open(map, OSUmarker);
	});
	var bounds = new google.maps.LatLngBounds();
	var icons = {
		recovery: {
			icon: 'http://maps.google.com/mapfiles/ms/micons/recycle.png'
	  	},
		manufacturing: {
			icon: 'https://maps.google.com/mapfiles/kml/pal4/icon47.png'
	       }
	};
	var infowindow = new google.maps.InfoWindow();
	downloadUrl('http://web.engr.oregonstate.edu/~niguang/getData.php?type="cardboard"', function(data) {
		var xml = data.responseXML;
		var coordArray = [];
       		//console.log(xml);
      		var markers = xml.documentElement.getElementsByTagName('marker');
      		Array.prototype.forEach.call(markers, function(markerElem) {
        		var id = markerElem.getAttribute('id');
        		var name = markerElem.getAttribute('name');
        		var type = markerElem.getAttribute('type');
			    var hyperlink = markerElem.getAttribute('hyperlink');
			    var image = markerElem.getAttribute('image');
        		var point = new google.maps.LatLng(
            			parseFloat(markerElem.getAttribute('lat')),
            			parseFloat(markerElem.getAttribute('lng')));
			coordArray.push({lat: point.lat(), lng: point.lng()});
        		var marker = new google.maps.Marker({
          			map: map,
          			position: point,
          			//label: icon.label
        		});

        		marker.addListener('click', function() {
	   			infowindow.close();
           		infowindow.open(map, marker);
	   			infowindow.setContent('<div><strong>' + name + '</strong><br>' +
				'type: ' + type + ' recycling<br>'
				+ 'Image: <img src="' + image + '"' + image + 'alt="Insert Image Here" height="71" width="106"></br>'
				+ 'Website: <a href="' + hyperlink + '">' + hyperlink + '</a><br></div>');
	    		});
      		});
		var lineSymbol = {
			path: 'M 0,-1 0,1',
          		strokeOpacity: 1,
          		scale: 4
        	};
		poly = new google.maps.Polyline({
			strokeColor: '#778899',
			strokeOpacity: 0,
          		icons: [{
           			icon: lineSymbol,
            			offset: '0',
            			repeat: '20px'
          		}],
			map: map,
        	});
		map.addListener('click', addTrack);
		var i = 1;
		var path = [OSUmarker.getPosition(), coordArray[0]];
		function addTrack(event){
			poly.setPath(path);
			if(path.length > 2)
				path.pop();
			path.push(coordArray[i]);
			if(i < coordArray.length)
				i++;
		}

		poly.setMap(map);
	/*
		var i = 1;
		var path = [OSUmarker.getPosition(), coordArray[0]];
		function addTrack(event){
			poly.setPath(path);
			path.push(coordArray[i]);
			poly.setMap(map);
			if(i < coordArray.length)
				i++;
		}
	*/
    	});
 }
    </script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD_IYVSOyU89P04LDsSj1h5kJcB6DPN8nQ&callback=initMap">
</script>
</body>

</html>
